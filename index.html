<!DOCTYPE html>
<html>
<head>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <title>UWCCSC_Ceremony_2025</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background: #f5f5f5;
            overflow: hidden;
            position: relative;
            height: 100vh;
        }

        #message-container {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .message {
            position: absolute;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 18px;
            white-space: nowrap;
            opacity: 1;
            left: 0;
            transform: translateX(-100%);
            animation-timing-function: linear;
            animation-fill-mode: forwards;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        #countdown {
            position: fixed;
            top: 20px;
            right: 20px;
            font-size: 24px;
            background: rgba(255,255,255,0.8);
            padding: 10px 15px;
            border-radius: 10px;
            z-index: 100;
        }

        #video-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 40%;
            max-width: 500px;
            display: none;
            background: black;
            border-radius: 8px;
            overflow: hidden;
            z-index: 100;
        }

        #video-player {
            width: 100%;
            height: auto;
        }

        #qr-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            text-align: center;
            background: rgba(255,255,255,0.8);
            padding: 10px;
            border-radius: 10px;
            z-index: 100;
        }

        #start-button {
            position: fixed;
            top: 20px;
            left: 20px;
            font-size: 18px;
            background: #4285f4;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            z-index: 100;
        }

        #start-button:hover {
            background: #3367d6;
        }
    </style>
</head>
<body>
<button id="start-button">Start Countdown</button>
<div id="countdown" style="display: none;">03:00</div>
<div id="message-container"></div>
<div id="video-container">
    <video id="video-player" controls autoplay></video>
</div>
<div id="qr-container">
    <div id="qrcode"></div>
</div>

<!-- Firebase SDK -->
<script src="js/supabase.min.js"></script>
<!-- QR Code Library -->
<script src="js/qrcode.min.js"></script>

<script>
    // Initialize Supabase
    const SUPABASE_URL = 'https://wzwvsbgmiisxloyfkqdr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6d3ZzYmdtaWlzeGxveWZrcWRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5MDI0OTIsImV4cCI6MjA2MzQ3ODQ5Mn0.ZbwYwH2TW4nFUUEzaIhWKZfXitDGcUEcmOwXf9Ryay4';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Generate QR Code
    function getBaseURL() {
        return window.location.origin;
    }
    const submitURL = `${getBaseURL()}/submit`;
    new QRCode(document.getElementById("qrcode"), {
        text: submitURL,
        width: 100,
        height: 100
    });

    // Light color palette for messages
    const colors = [
        '#FF9A76', '#FF7676', '#C5E07F', '#72D6A0', '#92CFEF',
        '#FFA4B2', '#D4E684', '#5EC3B9', '#8B9CD9', '#E48DB3',
        '#FFC97E', '#6FAED6', '#F5A6C8', '#94DFA3', '#FFB38A',
        '#86AAD5', '#D1A5FF', '#A2DFDF', '#F1C76D', '#9FBABB'
    ];

    // Plan B messages
    const planBMessages = [
        "Congratulations to all graduates!",
        "Your hard work has paid off!",
        "The future belongs to you!",
        "Dream big and achieve bigger!",
        "Today is just the beginning!",
        "Proud of your accomplishments!",
        "The world needs your talents!",
        "Celebrate this milestone!",
        "Your journey continues!",
        "Make your mark on the world!"
    ];

    // Variables for message queue
    let messageQueue = [];
    let isAnimating = false;
    let messageElements = [];
    let playedMessageIds = new Set();
    let planBActive = false;
    let planBTimer = null;

    // Countdown variables
    let countdownTime = 3 * 60; // 3 minutes in seconds
    const countdownElement = document.getElementById('countdown');
    let countdownInterval;

    // Video container
    const videoContainer = document.getElementById('video-container');
    const videoPlayer = document.getElementById('video-player');

    // Start button
    const startButton = document.getElementById('start-button');

    // Function to start countdown
    function startCountdown() {
        startButton.style.display = 'none';
        countdownElement.style.display = 'block';
        updateCountdownDisplay();
        countdownInterval = setInterval(() => {
            countdownTime--;
            updateCountdownDisplay();

            if (countdownTime <= 0) {
                clearInterval(countdownInterval);
                playVideo();
                if (planBTimer) clearInterval(planBTimer);
            }
        }, 1000);

        // Start Plan B check after 25 seconds
        setTimeout(() => {
            if (messageQueue.length === 0 && !planBActive) {
                activatePlanB();
            }
        }, 25000);
    }

    function updateCountdownDisplay() {
        const minutes = Math.floor(countdownTime / 60);
        const seconds = countdownTime % 60;
        countdownElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    function playVideo() {
        // Replace with your video URL
        videoPlayer.src = 'https://streamable.com/odummk';
        videoContainer.style.display = 'block';
        videoPlayer.play();
    }

    // Function to activate Plan B
    async function activatePlanB() {
        planBActive = true;
        console.log("Activating Plan B - using prepared messages");

        try {
            // Fetch the planb.txt file
            const response = await fetch('planb.txt');
            if (!response.ok) {
                throw new Error('Failed to load planb.txt');
            }

            const text = await response.text();
            // Split by newlines and filter out empty lines
            const messages = text.split('\n').filter(msg => msg.trim() !== '');

            if (messages.length === 0) {
                throw new Error('planb.txt is empty');
            }

            // Add all Plan B messages to queue
            messages.forEach((msg, index) => {
                messageQueue.push({
                    id: `planb-${index}`,
                    text: msg.trim(),
                    isPlanB: true
                });
            });

            // Process queue if not already animating
            if (!isAnimating) {
                processQueue();
            }
        } catch (error) {
            console.error('Error loading Plan B messages:', error);
            // Fallback to hardcoded messages if planb.txt fails
            const fallbackMessages = [
                "Congratulations to all graduates!",
                "Your hard work has paid off!",
                "The future belongs to you!",
                "Dream big and achieve bigger!",
                "Today is just the beginning!"
            ];

            fallbackMessages.forEach((msg, index) => {
                messageQueue.push({
                    id: `planb-fallback-${index}`,
                    text: msg,
                    isPlanB: true
                });
            });

            if (!isAnimating) {
                processQueue();
            }
        }
    }

    // Function to get a random color
    function getRandomColor() {
        return colors[Math.floor(Math.random() * colors.length)];
    }

    // Function to get a random Y position (avoiding top and bottom edges)
    function getRandomYPosition() {
        return 10 + Math.random() * 70; // 10% to 80% of viewport height
    }

    // Function to record a message as played
    async function recordPlayedMessage(messageId) {
        if (messageId.startsWith('planb-')) return; // Don't record Plan B messages

        try {
            const { error } = await supabase
                .from('played')
                .insert([{ message_id: messageId }]);

            if (error) throw error;
            playedMessageIds.add(messageId);
        } catch (error) {
            console.error('Error recording played message:', error);
        }
    }

    // Function to get already played messages
    async function fetchPlayedMessages() {
        try {
            const { data, error } = await supabase
                .from('played')
                .select('message_id');

            if (error) throw error;

            if (data && data.length > 0) {
                data.forEach(item => {
                    playedMessageIds.add(item.message_id);
                });
            }
        } catch (error) {
            console.error('Error fetching played messages:', error);
        }
    }

    // Function to animate a message
    function animateMessage(messageElement, duration, callback) {
        const startTime = performance.now();
        const containerWidth = document.getElementById('message-container').clientWidth;
        const messageWidth = messageElement.clientWidth;
        const targetX = containerWidth - messageWidth;

        function step(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);

            // Move from left to right
            const translateX = progress * targetX;
            messageElement.style.transform = `translateX(${translateX}px)`;

            // Fade out when near the end
            if (progress > 0.8) {
                messageElement.style.opacity = 1 - (progress - 0.8) * 5;
            }

            if (progress < 1) {
                requestAnimationFrame(step);
            } else {
                messageElement.remove();
                messageElements = messageElements.filter(el => el !== messageElement);
                if (callback) callback();
            }
        }

        requestAnimationFrame(step);
    }

    // Function to process the message queue
    function processQueue() {
        if (messageQueue.length === 0 || isAnimating) return;

        isAnimating = true;
        const messageData = messageQueue.shift();

        const messageElement = document.createElement('div');
        messageElement.className = 'message';
        messageElement.textContent = messageData.text;
        messageElement.style.top = `${getRandomYPosition()}%`;
        messageElement.style.backgroundColor = getRandomColor();
        if (messageData.id) {
            messageElement.dataset.id = messageData.id;
        }

        document.getElementById('message-container').appendChild(messageElement);
        messageElements.push(messageElement);

        // Record the message as played (if not Plan B)
        if (messageData.id && !messageData.isPlanB) {
            recordPlayedMessage(messageData.id);
        }

        // Force layout calculation
        messageElement.offsetHeight;

        const duration = 20000; // 20 seconds animation duration
        animateMessage(messageElement, duration, () => {
            isAnimating = false;
            // Schedule next message in exactly 2 minutes (120000ms)
            setTimeout(processQueue, 120000 - duration);
        });
    }

    // Function to fetch messages from Supabase
    async function fetchMessages() {
        try {
            // Get messages from the last 5 minutes
            const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();

            const { data, error } = await supabase
                .from('messages')
                .select('*')
                .gte('timestamp', fiveMinutesAgo)
                .order('timestamp', { ascending: true });

            if (error) throw error;

            if (data && data.length > 0) {
                // Add new messages to queue that haven't been played
                data.forEach(message => {
                    if (!playedMessageIds.has(message.id.toString()) &&
                        !messageQueue.some(m => m.id === message.id) &&
                        !messageElements.some(el => el.dataset.id === message.id.toString())) {
                        messageQueue.push(message);
                    }
                });

                // Process queue if not already animating
                if (!isAnimating && messageQueue.length > 0) {
                    processQueue();
                }
            }
        } catch (error) {
            console.error('Error fetching messages:', error);
        }
    }

    // Set up real-time subscription
    function setupRealtime() {
        const subscription = supabase
            .channel('messages')
            .on('postgres_changes', {
                event: 'INSERT',
                schema: 'public',
                table: 'messages'
            }, payload => {
                // Add new message to queue if not already played
                if (!playedMessageIds.has(payload.new.id.toString())) {
                    messageQueue.push(payload.new);
                    if (!isAnimating) {
                        processQueue();
                    }
                }
            })
            .subscribe();
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', async () => {
        // First load played messages
        await fetchPlayedMessages();

        // Then fetch new messages
        fetchMessages();

        // Set up real-time
        setupRealtime();

        // Set up start button
        startButton.addEventListener('click', startCountdown);

        // Check for new messages every 30 seconds
        setInterval(fetchMessages, 30000);
    });
</script>
</body>
</html>